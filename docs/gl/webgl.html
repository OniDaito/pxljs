<!DOCTYPE html>

<html>
<head>
  <title>webgl.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>webgl.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="about">ABOUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>             .__   
_________  __|  |  
\____ \  \/  /  |  
|  |_&gt; &gt;    &lt;|  |__
|   __<span class="hljs-regexp">/__/</span>\_ \____/
|__|        \/     js

                    PXL.js
                    Benjamin Blundell - ben@pxljs.com
                    http:<span class="hljs-regexp">//</span>pxljs.com

This software <span class="hljs-keyword">is</span> released under the MIT Licence. See LICENCE.txt <span class="hljs-keyword">for</span> details


The WebGL End <span class="hljs-keyword">of</span> our basic primitives. Here we match our classes to the WebGL Shaders 
<span class="hljs-keyword">and</span> buffers

 - TODO
  * We are creating Float32Arrays <span class="hljs-literal">on</span> the fly. Fine, but we should possibly
    hold onto these buffers <span class="hljs-keyword">and</span> index into them, replacing geometry memory? I.e
    each vertex data bit points to its position <span class="hljs-keyword">in</span> the Float32Array? Could be expensive
    Shapes <span class="hljs-keyword">or</span> trimeshes could <span class="hljs-keyword">in</span> fact <span class="hljs-keyword">do</span> that I think.
  * Geometry may <span class="hljs-keyword">or</span> may <span class="hljs-keyword">not</span> have more buffers (should we wish to add them)
  * Do we put <span class="hljs-keyword">in</span> face duplication here? I.e, <span class="hljs-keyword">if</span> we want to pass <span class="hljs-keyword">in</span> per face details
    we need to change the buffers
  * It appears that bufferSubData <span class="hljs-keyword">isnt</span> the thing to use but <span class="hljs-keyword">is</span> <span class="hljs-keyword">this</span> <span class="hljs-literal">true</span>? (<span class="hljs-keyword">for</span> updateing)
  * Geometry that has changed totally? Delete <span class="hljs-keyword">and</span> redo buffers <span class="hljs-keyword">is</span> needed
  * Per Face Brew method - I.e duplicate vertices <span class="hljs-keyword">if</span> there <span class="hljs-keyword">is</span> per-face data specified <span class="hljs-keyword">in</span>
    the brew parameters</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>##</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

{Matrix4, Vec3, Vec2} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../math/math'</span>
{RGB,RGBA} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../colour/colour'</span>
{Geometry, Vertex, Triangle, Quad} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../geometry/primitive'</span>
{PXLWarning, PXLWarningOnce, PXLError} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../util/log'</span>
{Contract} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../gl/contract'</span>
{CacheVar} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../util/cache_var'</span>

util = <span class="hljs-built_in">require</span> <span class="hljs-string">"../util/util"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="geometrybrewer">GeometryBrewer</h2>
<p>A Mini Object attached to geometry in order for them
to be drawn to the screen via webgl</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
GeometryBrewer = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="setdatabuffer">setDataBuffer</h2>
<p>set the data for a buffer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">setDataBuffer</span> = <span class="hljs-params">(buffer, data, type)</span> -&gt;</span>
  gl = PXL.Context.gl
  gl.bindBuffer(gl.ARRAY_BUFFER, buffer)
  gl.bufferData(gl.ARRAY_BUFFER, data, type)
  gl.bindBuffer(gl.ARRAY_BUFFER, <span class="hljs-literal">null</span>)
  buffer</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="createarraybuffer">createArrayBuffer</h2>
<p>create a buffer of data per vertex</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">createArrayBuffer</span> = <span class="hljs-params">(data, type, size)</span> -&gt;</span>
  gl = PXL.Context.gl
  buffer = gl.createBuffer()
  setDataBuffer buffer,data,type
  buffer.itemSize = size
  buffer.numItems = data.length / size
  buffer</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="updatebuffer">updateBuffer</h2>
<p>A call to bufferSubData essentially</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">bufferSubData</span> = <span class="hljs-params">(buffer, data, offset)</span> -&gt;</span>
  gl = PXL.Context.gl
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> offset?
    offset = <span class="hljs-number">0</span>
  gl.bindBuffer(gl.ARRAY_BUFFER, buffer)
  gl.bufferSubData(gl.ARRAY_BUFFER, offset, data)
  gl.bindBuffer(gl.ARRAY_BUFFER, <span class="hljs-literal">null</span>)
  buffer</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="createelementbuffer">createElementBuffer</h2>
<p>create a buffer of indices</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">createElementBuffer</span> = <span class="hljs-params">(data, type, size)</span> -&gt;</span>
  gl = PXL.Context.gl
  buffer = gl.createBuffer()
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, buffer)
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, data, type)
  buffer.itemSize = size
  buffer.numItems = data.length
  gl.bindBuffer(gl.ARRAY_BUFFER, <span class="hljs-literal">null</span>)
  buffer</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="deletebuffer">deleteBuffer</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">deleteBuffer</span> = <span class="hljs-params">(buffer)</span> -&gt;</span>
  gl = PXL.Context.gl
  gl.deleteBuffer(buffer)
  @</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="_attribtypecheckset">_attribTypeCheckSet</h2>
<p>check and set an attribute pointer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">_attribTypeCheckSet</span> = <span class="hljs-params">(a, v)</span> -&gt;</span>
  gl = PXL.Context.gl
  <span class="hljs-keyword">if</span> a.pos == <span class="hljs-number">-1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>PXLWarningOnce “Trying to set an attribute “ + a.name + “ that isnt used in the bound shader”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span>
      
  gl.bindBuffer(gl.ARRAY_BUFFER, v )

  <span class="hljs-keyword">if</span> a.type == GL.LOW_INT <span class="hljs-keyword">or</span> a.type == GL.MEDIUM_INT <span class="hljs-keyword">or</span> a.type == GL.HIGH_INT
    gl.vertexAttribPointer(a.pos, <span class="hljs-number">1</span>, gl.INT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> a.type == GL.LOW_FLOAT <span class="hljs-keyword">or</span> a.type == GL.MEDIUM_FLOAT <span class="hljs-keyword">or</span> a.type == GL.HIGH_FLOAT
    gl.vertexAttribPointer(a.pos, <span class="hljs-number">1</span>, gl.FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> a.type == GL.FLOAT_VEC2
    gl.vertexAttribPointer(a.pos, <span class="hljs-number">2</span>, gl.FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> a.type == GL.FLOAT_VEC3
    gl.vertexAttribPointer(a.pos, <span class="hljs-number">3</span>, gl.FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> a.type == GL.FLOAT_VEC4
    gl.vertexAttribPointer(a.pos, <span class="hljs-number">4</span>, gl.FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO Attributes of matrices potentially for skeletal animation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  gl.enableVertexAttribArray(a.pos)
  @</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="_uniformtypecheckset">_uniformTypeCheckSet</h2>
<p>check and set a uniform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">_uniformTypeCheckSet</span> = <span class="hljs-params">(u,v)</span> -&gt;</span>

  <span class="hljs-keyword">if</span> u.pos == <span class="hljs-number">-1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>PXLWarningOnce “Trying to set the uniform “ + u.name + “ that isnt used in the bound shader”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Check if v is actually a cache_var and if so, check it’s dirty flag. If dirty, extract variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> v <span class="hljs-keyword">instanceof</span> CacheVar
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> v.isDirty()
      <span class="hljs-keyword">return</span>

    v = v.get()

  gl = PXL.Context.gl
  <span class="hljs-keyword">if</span> u.size == <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> u.type == GL.LOW_FLOAT <span class="hljs-keyword">or</span> u.type == GL.MEDIUM_FLOAT <span class="hljs-keyword">or</span> u.type == GL.HIGH_FLOAT <span class="hljs-keyword">or</span> u.type == GL.FLOAT
      gl.uniform1f(u.pos,v)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.LOW_INT <span class="hljs-keyword">or</span> u.type == GL.MEDIUM_INT <span class="hljs-keyword">or</span> u.type == GL.HIGH_INT <span class="hljs-keyword">or</span> u.type == GL.INT
      gl.uniform1i(u.pos,v)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC2
      gl.uniform2f(u.pos,v.x, v.y) <span class="hljs-comment"># Vec2</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC3
      <span class="hljs-keyword">if</span> v.x?
        gl.uniform3f(u.pos, v.x, v.y, v.z) <span class="hljs-comment">#Vec3</span>
      <span class="hljs-keyword">else</span>
        gl.uniform3f(u.pos, v.r, v.g, v.b) <span class="hljs-comment">#Colour.RGB</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC4
      <span class="hljs-keyword">if</span> v.x?
        gl.uniform4f(u.pos,v.x, v.y, v.z, v.w) <span class="hljs-comment"># Vec4</span>
      <span class="hljs-keyword">else</span>
        gl.uniform4f(u.pos,v.r, v.g, v.b, v.a) <span class="hljs-comment">#Colour.RGBA</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_MAT4
      gl.uniformMatrix4fv(u.pos, <span class="hljs-literal">false</span>, v.a)  <span class="hljs-comment"># Expecting a matrix here!</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_MAT3
      gl.uniformMatrix3fv(u.pos, <span class="hljs-literal">false</span>, v.a)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.SAMPLER_2D</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>This is a bit tricksy as we are assuming we are passing an integer referring to the unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      gl.uniform1i(u.pos, v)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO - Sampler cube</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">else</span> <span class="hljs-comment">#if v instanceof Array</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Check to see if we are passing objects that have a flatten command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">if</span> v[<span class="hljs-number">0</span>] <span class="hljs-keyword">instanceof</span> Object
      t = []
      <span class="hljs-keyword">if</span> v[<span class="hljs-number">0</span>].flatten?
        t = t.concat x.flatten() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> v 
        <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC2
          gl.uniform2fv u.pos, <span class="hljs-keyword">new</span> Float32Array t <span class="hljs-comment"># Vec2</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC3
          gl.uniform3fv u.pos, <span class="hljs-keyword">new</span> Float32Array t <span class="hljs-comment">#Vec3</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC4
          gl.uniform4fv u.pos, <span class="hljs-keyword">new</span> Float32Array t
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> v[<span class="hljs-number">0</span>].a</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>TODO - This is nasty and we dont want to have to repeat it &gt;&lt;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      
        <span class="hljs-keyword">if</span> u.type == GL.FLOAT_MAT3
          t = <span class="hljs-keyword">new</span> Float32Array(<span class="hljs-number">9</span>*v.length)
          idx = <span class="hljs-number">0</span>
          <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> v
            t.set m.a, idx*<span class="hljs-number">9</span>
            idx++
          gl.uniformMatrix3fv u.pos, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> Float32Array t
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_MAT4
          t = <span class="hljs-keyword">new</span> Float32Array(<span class="hljs-number">16</span>*v.length)
          idx = <span class="hljs-number">0</span>
          <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> v
            t.set m.a, idx*<span class="hljs-number">16</span>
            idx++
          gl.uniformMatrix4fv u.pos, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> Float32Array t

    <span class="hljs-keyword">else</span>

      <span class="hljs-keyword">if</span> u.type == GL.LOW_FLOAT <span class="hljs-keyword">or</span> u.type == GL.MEDIUM_FLOAT <span class="hljs-keyword">or</span> u.type == GL.HIGH_FLOAT
        gl.uniform1fv u.pos, <span class="hljs-keyword">new</span> Float32Array v
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.LOW_INT <span class="hljs-keyword">or</span> u.type == GL.MEDIUM_INT <span class="hljs-keyword">or</span> u.type == GL.HIGH_INT
        gl.uniform1iv u.pos, <span class="hljs-keyword">new</span> Int32Array v <span class="hljs-comment"># Vec2</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC2
        gl.uniform2fv u.pos, <span class="hljs-keyword">new</span> Float32Array v <span class="hljs-comment"># Vec2</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC3
        gl.uniform3fv u.pos, <span class="hljs-keyword">new</span> Float32Array v <span class="hljs-comment">#Vec3</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_VEC4
        gl.uniform4fv u.pos, <span class="hljs-keyword">new</span> Float32Array v <span class="hljs-comment"># Vec4</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_MAT3
        gl.uniformMatrix3fv u.pos, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> Float32Array v
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> u.type == GL.FLOAT_MAT4
        gl.uniformMatrix4fv u.pos, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> Float32Array v
  @</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="_joincontracts">_joinContracts</h2>
<p>Given an object or object hierarchy within a node, check them
against the contract. Recursive call down all objects if they
have a contract.
TODO - is this function better off in the contract class?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">_joinContracts</span> = <span class="hljs-params">(obj, shader_contract)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Attempt to join the contracts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Contract.join(shader_contract, obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>This is a bit crap but so far it’s the best option to speed things up
We sort of need a reserved words on node / object really</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> prop <span class="hljs-keyword">of</span> obj
    <span class="hljs-keyword">if</span> prop <span class="hljs-keyword">in</span> [<span class="hljs-string">"children"</span>, <span class="hljs-string">"faces"</span>, <span class="hljs-string">"indices"</span>, <span class="hljs-string">"vertices"</span>, <span class="hljs-string">"normals"</span>, <span class="hljs-string">"texcoords"</span>]
      <span class="hljs-keyword">continue</span>

    <span class="hljs-keyword">if</span> obj[prop]? <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> obj[prop] == <span class="hljs-string">"object"</span>
     
      <span class="hljs-keyword">if</span> obj[prop].contract?
        _joinContracts obj[prop], shader_contract

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> obj[prop] <span class="hljs-keyword">instanceof</span> Array
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> obj[prop]
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> item == <span class="hljs-string">"object"</span> <span class="hljs-keyword">and</span> item.contract?
            _joinContracts item, shader_contract

  obj</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="matchwithshader">matchWithShader</h2>
<p>If this obj is drawable, match the uniforms
Given the current context, we should have a shader with a @contract 
if we do, attempt to match it. It is worth noting that one node on
its own may not suffice for the entire shader contract and that 
others may fill in the gaps further down.</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>TODO - We need to do caching here as well I think</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">matchWithShader</span> = <span class="hljs-params">(obj)</span> -&gt;</span>

  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> PXL.Context.shader?
    PXLError(<span class="hljs-string">"No Shader bound when calling matchWithShader"</span>)
    <span class="hljs-keyword">return</span> obj
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> PXL.Context.shader.contract?
    PXLError(<span class="hljs-string">"No Shader contract when calling matchWithShader"</span>)
    <span class="hljs-keyword">return</span> obj

  shader_contract = PXL.Context.shader.contract
  shader = PXL.Context.shader

  _joinContracts(obj, shader_contract)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Now we’ve joined contracts, lets check all the types
Hopefully they will be all matched at this point ;)
Match the uniforms first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> shader_contract.uniforms    
    <span class="hljs-keyword">if</span> shader_contract.matches[u.name]?
      _uniformTypeCheckSet(u, shader_contract.matches[u.name])</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Match the attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> shader_contract.attributes    
    <span class="hljs-keyword">if</span> shader_contract.matches[a.name]?
      _attribTypeCheckSet(a, shader_contract.matches[a.name])

  obj</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="geometrybrewer-brew">GeometryBrewer.brew</h2>
<p>given some geometry, move that onto the graphics card. Called internally but also can be called by the user.
params is a dictionary of parameters. Currently accepting: </p>
<p><name>_buffer_access : GL.STATIC_DRAW, GL.DYNAMIC_DRAW etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

GeometryBrewer.brew = <span class="hljs-function"><span class="hljs-params">(params)</span> -&gt;</span>

  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @flat <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> @vertices? <span class="hljs-keyword">or</span> @vertices.length &lt;= <span class="hljs-number">0</span>)
    @brewed = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> @

  gl = PXL.Context.gl
  
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> params?
    params = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>We make the assumption that all vertices are the same in data
TODO - Eventually face colours and face normals</p>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>TODO - This repeats a lot so it should be tidied up a little I think
Also, combining buffers as well :O What then with our shader contracts?
ultimately, our shaders are still a little too decoupled, though with shader library
maybe we get around that?</p>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Actually perform the brewing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">minorBrew</span> = <span class="hljs-params">(flat,name,gattr,pattr,size)</span> =&gt;</span>

    access = <span class="hljs-keyword">if</span> params[pattr]? <span class="hljs-keyword">then</span> params[pattr] <span class="hljs-keyword">else</span> gl.STATIC_DRAW

    <span class="hljs-keyword">if</span> flat
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @[name]?
        @[name] = createArrayBuffer(@[gattr], access, size)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">if</span> @[gattr].length == @[name].numItems
          setDataBuffer @[name], @[gattr], access
        <span class="hljs-keyword">else</span>
          PXLWarningOnce <span class="hljs-string">"Attemping to update position buffer of different length"</span>

    <span class="hljs-keyword">else</span>
      new_verts = []
      new_verts = new_verts.concat v[gattr].flatten() <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> @vertices

      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @[name]?</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Always Float32Arrays?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @[name] = createArrayBuffer(<span class="hljs-keyword">new</span> Float32Array(new_verts), access, size)
      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Assume if the same size, its the same order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> @vertices.length == @[name].numItems
          setDataBuffer @[name], <span class="hljs-keyword">new</span> Float32Array(new_verts), access
        <span class="hljs-keyword">else</span>
          PXLWarningOnce <span class="hljs-string">"Attemping to update position buffer of different length"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Flat geometry is already in the arrays so we dont need to compress. We have the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> @flat</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Look at the contract to decide what we compress</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> @contract.roles
      name = @contract.roles[key]

      <span class="hljs-keyword">if</span> @[ name ] <span class="hljs-keyword">instanceof</span> Float32Array
        minorBrew <span class="hljs-literal">true</span>, <span class="hljs-string">"vertex"</span> + key + <span class="hljs-string">"Buffer"</span>, key, key + <span class="hljs-string">"_buffer_access"</span>, @_flat_sizes[name]

  <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>We look at everything that is attached to a vertex and is in
the contract with the right name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> @vertices[<span class="hljs-number">0</span>]

      role_name = <span class="hljs-string">"vertex"</span> + key + <span class="hljs-string">"Buffer"</span>
      <span class="hljs-keyword">if</span> @contract.hasRoleValue(role_name) <span class="hljs-keyword">and</span> key != <span class="hljs-literal">undefined</span>
        vert = @vertices[<span class="hljs-number">0</span>]
        datatype = vert[key]
        size = datatype.DIM
        minorBrew <span class="hljs-literal">false</span>, role_name, key, key + <span class="hljs-string">"_buffer_access"</span>, size</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Indices</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  access = <span class="hljs-keyword">if</span> params.indices_buffer_access? <span class="hljs-keyword">then</span> params.indices_buffer_access <span class="hljs-keyword">else</span> gl.STATIC_DRAW

  <span class="hljs-keyword">if</span> @indexed
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @vertexIndexBuffer?
      @vertexIndexBuffer = createElementBuffer(<span class="hljs-keyword">new</span> Uint16Array(@indices), access, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> @indices.length == @vertexIndexBuffer.numItems
        setDataBuffer @vertexIndexBuffer, <span class="hljs-keyword">new</span> Float32Array(@indices), access
      <span class="hljs-keyword">else</span>
        PXLWarningOnce <span class="hljs-string">"Attemping to update indices buffer of different length"</span>

  @brewed = <span class="hljs-literal">true</span> 
  @</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="geometrybrewer-rebrew">GeometryBrewer.rebrew</h2>
<p>For geometry that is already brewed, rebrew whichever has changed.
The user must specify which buffers / vertex attribs to change :)
params is a dictionary of parameters and is optional but at least
one buffer must be set with its offset
Currently accepting: </p>
<p><name>_buffer : an integer representing the offset. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

GeometryBrewer.rebrew = <span class="hljs-function"><span class="hljs-params">(params)</span> -&gt;</span>

  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> params?
    <span class="hljs-keyword">return</span> @

  <span class="hljs-keyword">if</span> @brewed == <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> @

  gl = PXL.Context.gl

  <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> params
    <span class="hljs-keyword">if</span> @flat
      name = <span class="hljs-string">"vertex"</span> + key + <span class="hljs-string">"Buffer"</span>
      <span class="hljs-keyword">if</span> @[name]?
        bufferSubData @[name], @[key], params[key]
    <span class="hljs-keyword">else</span>
      items = []
      items = items.concat v[key].flatten() <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> @vertices
      name = <span class="hljs-string">"vertex"</span> + key + <span class="hljs-string">"Buffer"</span>
      <span class="hljs-keyword">if</span> @[name]?
        bufferData @[name], <span class="hljs-keyword">new</span> Float32Array(items), params[key]

  @</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="rebrew_typed">rebrew_typed</h2>
<p>For geometry that is already brewed, rebrew it as above but with the data already typed.
For large geometries (anything above about 1000 verts) this method is much better
This means the buffer will be out of sync with the data held on the geometry.
params is a dictionary of parameters and is optional but at least
one buffer must be set with its offset
Currently accepting: 
colour_buffer : another dictionary containing {offset: 0 , data : <typed_data> } 
position_buffer : as above
normal_buffer: as above
texcoord_buffer : as above
tangent_buffer : as above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">rebrew_typed</span> = <span class="hljs-params">(geometry, params)</span> =&gt;</span>
  
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> params?
    <span class="hljs-keyword">return</span> @

  <span class="hljs-keyword">if</span> @brewed == <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> @

  gl = PXL.Context.gl</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Colours</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> params.colour_buffer?
    <span class="hljs-keyword">if</span> geometry.vertexColourBuffer?
      bufferSubData(geometry.vertexColourBuffer, params.colour_buffer.data, params.colour_buffer.offset)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Positions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> params.position_buffer?
    <span class="hljs-keyword">if</span> geometry.vertexPositionBuffer?
      bufferSubData(geometry.vertexPositionBuffer, params.position_buffer.data, params.position_buffer.offset)</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>normals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> params.normal_buffer?
    <span class="hljs-keyword">if</span> geometry.vertexNormalBuffer?
      bufferSubData(geometry.vertexNormalBuffer, params.normal_buffer.data, params.normal_buffer.offset)</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>UVs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> params.texcoord_buffer?
    <span class="hljs-keyword">if</span> geometry.vertexTextureBuffer?
      bufferSubData(geometry.vertexTextureBuffer, params.texcoord_buffer.data, params.texcoord_buffer.offset)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>tangent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> params.tangent_buffer?
    <span class="hljs-keyword">if</span> geometry.vertexTangentBuffer?
      bufferSubData(geometry.vertexTangentBuffer, params.tangent_buffer.data, params.tangent_buffer.offset)

  @</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>drawGL - bind the buffers and make the draw call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>GeometryBrewer.drawGL = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> 

  gl = PXL.Context.gl
  <span class="hljs-keyword">if</span> @vertexIndexBuffer? <span class="hljs-keyword">and</span> @indexed
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, @vertexIndexBuffer);
    gl.drawElements(@layout, @vertexIndexBuffer.numItems, gl.UNSIGNED_SHORT,<span class="hljs-number">0</span>);
  <span class="hljs-keyword">else</span>
    gl.drawArrays(@layout, <span class="hljs-number">0</span>, @vertexpBuffer.numItems);

  @</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>washup - remove any attachments to this node, and off the graphics card
TODO - Needs testing I think</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
GeometryBrewer.washup = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  
  <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> @
    <span class="hljs-keyword">if</span> @[key] <span class="hljs-keyword">instanceof</span> WebGLBuffer
      deleteBuffer @[key]


<span class="hljs-built_in">module</span>.exports = 
  rebrew_typed : rebrew_typed
  GeometryBrewer : GeometryBrewer
  matchWithShader : matchWithShader</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
