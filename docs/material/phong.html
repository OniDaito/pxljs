<!DOCTYPE html>

<html>
<head>
  <title>phong.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>phong.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="about">ABOUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>             .__   
_________  __|  |  
\____ \  \/  /  |  
|  |_&gt; &gt;    &lt;|  |__
|   __<span class="hljs-regexp">/__/</span>\_ \____/
|__|        \/     js

                    PXL.js
                    Benjamin Blundell - ben@pxljs.com
                    http:<span class="hljs-regexp">//</span>pxljs.com

This software <span class="hljs-keyword">is</span> released under the MIT Licence. See LICENCE.txt <span class="hljs-keyword">for</span> details

This software <span class="hljs-keyword">is</span> released under the MIT Licence. See LICENCE.txt <span class="hljs-keyword">for</span> details</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>##</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
{RGB,RGBA} = <span class="hljs-built_in">require</span> <span class="hljs-string">"../colour/colour"</span>
{Material} = <span class="hljs-built_in">require</span> <span class="hljs-string">"./material"</span>
{Texture} = <span class="hljs-built_in">require</span> <span class="hljs-string">"../gl/texture"</span>
{uber_phong_diff_tex, uber_phong_spec_tex, uber_phong_emis_tex, uber_vertex_colour, uber_phong_mat} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../gl/uber_shader_paths'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO - transparent alpha blending materials</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>We donâ€™t reference textures. Rather, textures are sampled and are set to the variable baseColour
which can either be a texture or a basic passed in colour. This variable is common throughout all
shaders.</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>##UberShaderPhong###
The text for the ubershader when we are using phong materials
Hash defines and paths include</p>
<p>MAT_PHONG</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UberShaderPhong</span></span>

  @fragment_head : <span class="hljs-string">"#ifdef MAT_PHONG\nuniform vec3 uMaterialAmbientColour;\nuniform float uMaterialShininess;\n"</span> +
    <span class="hljs-string">"\nuniform vec3 uMaterialDiffuseColour;\n"</span> + 
    <span class="hljs-string">"\nuniform sampler2D uSamplerDiffuse;\n"</span> +
    <span class="hljs-string">"\nuniform vec3 uMaterialSpecularColour;\n"</span> +
    <span class="hljs-string">"\nuniform sampler2D uSamplerSpecular;\n"</span> +
    <span class="hljs-string">"\nuniform vec3 uMaterialEmissiveColour;\n"</span> +
    <span class="hljs-string">"\nuniform sampler2D uSamplerEmissive;\n#endif\n"</span>

  @fragment_main : <span class="hljs-string">"#ifdef MAT_PHONG\nvec3 materialDiffuseColour = uMaterialDiffuseColour;\n"</span> +
    <span class="hljs-string">"vec3 materialSpecularColour;\n"</span> +
    <span class="hljs-string">"vec3 materialEmissiveColour;\n"</span> +
    <span class="hljs-string">"if(bitcheck(uUber0,10)){ materialDiffuseColour = texture2D(uSamplerDiffuse, vTexCoord).rgb;}\n"</span> +
    <span class="hljs-string">"materialSpecularColour = uMaterialSpecularColour;\n"</span> +
    <span class="hljs-string">"if(bitcheck(uUber0,11)){ materialSpecularColour = texture2D(uSamplerSpecular, vTexCoord).rgb;}\n"</span> +
    <span class="hljs-string">"materialEmissiveColour = uMaterialEmissiveColour;\n"</span> +
    <span class="hljs-string">"if(bitcheck(uUber0,12)){ materialEmissiveColour = texture2D(uSamplerEmissive, vTexCoord).rgb;}\n"</span> +

    <span class="hljs-string">"vec3 specularLightWeighting = vec3(0.0, 0.0, 0.0);\n"</span> +
    <span class="hljs-string">"vec3 diffuseLightWeighting = vec3(0.0, 0.0, 0.0);\n"</span> +
    <span class="hljs-string">"vec3 materialAmbientColour = uMaterialAmbientColour * uAmbientLightingColour;\n"</span> +
    <span class="hljs-string">"gl_FragColor = vec4(materialAmbientColour, 1.0);\n"</span> + 
    <span class="hljs-string">"vec3 eyeDirection = normalize(-vPosition.xyz);\n"</span> +
    <span class="hljs-string">"#ifdef LIGHTING_POINT\n"</span> +
    <span class="hljs-string">"for (int i=0; i &lt; LIGHTING_NUM_POINT_LIGHTS; i++) {\n"</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>TODO could potentially transform the lights in the vertex shader?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"  vec3 lightDirection = normalize((uModelMatrix * vec4(uPointLightPos[i],1.0)).xyz - vPosition.xyz);\n"</span> +
    <span class="hljs-string">"  vec3 reflectionDirection = reflect(-lightDirection, vTransformedNormal.xyz);\n"</span> +
    <span class="hljs-string">"  float specularLightBrightness = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uMaterialShininess);\n"</span> +
    <span class="hljs-string">"  specularLightWeighting = specularLightWeighting + (uPointLightColour[i] * specularLightBrightness);\n"</span> +
    <span class="hljs-string">"  float diffuseLightBrightness = max(dot(vTransformedNormal.xyz, lightDirection), 0.0);\n"</span> +
    <span class="hljs-string">"  diffuseLightWeighting = diffuseLightWeighting + (uPointLightColour[i] * diffuseLightBrightness);\n"</span> +
    <span class="hljs-string">"  gl_FragColor += vec4( materialDiffuseColour * diffuseLightWeighting "</span> +
    <span class="hljs-string">"   + materialSpecularColour * specularLightWeighting"</span> +
    <span class="hljs-string">"   + materialEmissiveColour,"</span> +
    <span class="hljs-string">"   0.0);\n"</span> +
    <span class="hljs-string">"}\n#endif\n#endif\n"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>##PhongMaterial###
A basic material that contains phong elements
Requires an existing lighting solution, complete with ambient light
We choose the lights using #ifdef statements that we set thus we can set the different lights</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhongMaterial</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Material</span></span>

  constructor: <span class="hljs-function"><span class="hljs-params">(@ambient, @diffuse, @specular, @shine, @emissive)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()

    @_uber_defines = [<span class="hljs-string">'MAT_PHONG'</span>, <span class="hljs-string">'VERTEX_NORMAL'</span>, <span class="hljs-string">'ADVANCED_CAMERA'</span>]

    @_preDrawCalls = []
    
    @ambient = <span class="hljs-keyword">new</span> RGB(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @ambient?
  
    @specular = <span class="hljs-keyword">new</span> RGB(<span class="hljs-number">1.0</span>,<span class="hljs-number">1.0</span>,<span class="hljs-number">1.0</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @specular?
    @shine = <span class="hljs-number">20.0</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @shine?
    @emissive = <span class="hljs-keyword">new</span> RGB(<span class="hljs-number">0.0</span>,<span class="hljs-number">0.0</span>,<span class="hljs-number">0.0</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @emissive?

    @contract.roles.uMaterialAmbientColour  = <span class="hljs-string">"ambient"</span>
    @contract.roles.uMaterialShininess = <span class="hljs-string">"shine"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Construct the shader chunks depending on what we are passed in.
TODO Texture Cube support for phong materials</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Essentially, given the parameters, we are creating subtly different
materials. This way is elegant for the end user but perhaps not so
elegant in terms of library. Phong is really a class of materials
but at the same time, I dont want to create another factory class just
to create textures. Ultimately, all we really care about is whether the 
generated shader will be different.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    usingTexture = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If not diffuse assume vertex colours
TODO - Finish off vertex diffuse colours</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @diffuse?
      @shaderChunks.push ShaderChunkLibrary.VertexColour
      @_uber0 = uber_vertex_colour <span class="hljs-literal">true</span>, @_uber0
    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO - Occasionally passing in RGBA causes this to fail. Best put a wrapper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> @diffuse <span class="hljs-keyword">instanceof</span> RGB
        @contract.roles.uMaterialDiffuseColour  = <span class="hljs-string">"diffuse"</span>
        @_uber0 = uber_phong_diff_tex <span class="hljs-literal">false</span>, @_uber0
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @diffuse <span class="hljs-keyword">instanceof</span> Texture
        @diffuse.contract.roles.uSamplerDiffuse = <span class="hljs-string">"unit"</span>
        @_preDrawCalls.push () =&gt;
          @diffuse.bind()
        usingTexture = <span class="hljs-literal">true</span>
        @_uber0 = uber_phong_diff_tex <span class="hljs-literal">true</span>, @_uber0</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>TODO - Also texture cube  would be good here as well</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> @specular <span class="hljs-keyword">instanceof</span> RGB
      @contract.roles.uMaterialSpecularColour = <span class="hljs-string">"specular"</span>
      @_uber0 = uber_phong_spec_tex <span class="hljs-literal">false</span>, @_uber0
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @specular <span class="hljs-keyword">instanceof</span> Texture
      @specular.contract.roles.uSamplerSpecular = <span class="hljs-string">"unit"</span>
      @_preDrawCalls.push () =&gt;
          @specular.bind()

      usingTexture = <span class="hljs-literal">true</span>
      @_uber0 = uber_phong_spec_tex <span class="hljs-literal">true</span>, @_uber0

    <span class="hljs-keyword">if</span> @emissive <span class="hljs-keyword">instanceof</span> RGB
      @contract.roles.uMaterialEmissiveColour = <span class="hljs-string">"emissive"</span>
      @_uber0 = uber_phong_emis_tex <span class="hljs-literal">false</span>, @_uber0
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @emissive <span class="hljs-keyword">instanceof</span> Texture
      @emissive.contract.roles.uSamplerEmissive = <span class="hljs-string">"unit"</span>
      @_preDrawCalls.push () =&gt;
        @emissive.bind()

      usingTexture = <span class="hljs-literal">true</span>
      @_uber0 = uber_phong_spec_tex <span class="hljs-literal">true</span>, @_uber0

    <span class="hljs-keyword">if</span> usingTexture
      @_uber_defines.push <span class="hljs-string">'VERTEX_TEXTURE'</span>

    @_uber0 = uber_phong_mat <span class="hljs-literal">true</span>, @_uber0</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Override to bind textures if there are any</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _preDraw : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> @_preDrawCalls
      func()

<span class="hljs-built_in">module</span>.exports =
  PhongMaterial : PhongMaterial
  UberShaderPhong : UberShaderPhong</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
