<!DOCTYPE html>

<html>
<head>
  <title>obj.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>obj.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="about">ABOUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>             .__   
_________  __|  |  
\____ \  \/  /  |  
|  |_&gt; &gt;    &lt;|  |__
|   __<span class="hljs-regexp">/__/</span>\_ \____/
|__|        \/     js

                    PXL.js
                    Benjamin Blundell - ben@pxljs.com
                    http:<span class="hljs-regexp">//</span>pxljs.com

This software <span class="hljs-keyword">is</span> released under the MIT Licence. See LICENCE.txt <span class="hljs-keyword">for</span> details


- A <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">to</span> <span class="hljs-title">import</span> <span class="hljs-title">OBJ</span> <span class="hljs-title">files</span></span>

- TODO
  - We are passing <span class="hljs-keyword">in</span> a queue here <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">modifies</span> <span class="hljs-title">it</span></span>
    - Do we want that, <span class="hljs-keyword">or</span> should <span class="hljs-keyword">this</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">implement</span> <span class="hljs-title">an</span> <span class="hljs-title">interface</span> <span class="hljs-title">of</span> <span class="hljs-title">some</span> <span class="hljs-title">kind</span>? <span class="hljs-title">Not</span> <span class="hljs-title">sure</span></span>

- Potentially

<span class="hljs-regexp">//</span> Check <span class="hljs-keyword">for</span> the various File API support.
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.File &amp;&amp; <span class="hljs-built_in">window</span>.FileReader &amp;&amp; <span class="hljs-built_in">window</span>.FileList &amp;&amp; <span class="hljs-built_in">window</span>.Blob) {
  <span class="hljs-regexp">//</span> Great success! All the File APIs are supported.
} <span class="hljs-keyword">else</span> {
  alert(<span class="hljs-string">'The File APIs are not fully supported in this browser.'</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>##</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
{PXLWarning, PXLError, PXLLog} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../util/log'</span>
{TriangleMesh, Triangle, Vertex} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../geometry/primitive'</span>
{Vec3, Vec2} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../math/math'</span>
{Node} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../core/node'</span>
{RGB} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../colour/colour'</span>
{Promise} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../util/promise'</span>
{Request} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../util/request'</span>
{PhongMaterial} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../material/phong'</span>
{BasicColourMaterial} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../material/basic'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>##OBJModel###
Load a basic OBJ Model as a set of nodes with materials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OBJModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Node</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Basic constructor for OBJ
@url - the URL to the object in question
@promise - this promise is honoured when everything is loaded 
TODO - We may wish to consider how this fits with queue and loading items :O</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  constructor: <span class="hljs-function"><span class="hljs-params">(@url, @promise)</span> -&gt;</span>

    <span class="hljs-keyword">super</span>()

    promise_main = <span class="hljs-keyword">new</span> Promise()
    promise_material = <span class="hljs-keyword">new</span> Promise()
    promise_data = <span class="hljs-keyword">new</span> Promise()
  
    promise_main.<span class="hljs-keyword">when</span>(promise_data).<span class="hljs-keyword">then</span> () =&gt;
      @promise.resolve()
<span class="hljs-function">
    <span class="hljs-title">load_data_promise</span> = <span class="hljs-params">()</span> =&gt;</span>
      r = <span class="hljs-keyword">new</span> Request(@url)
      r.get (data) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We assume that the material exists in the same place as the obj
TODO - allow setting the matlib path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        matlibName = @_checkForMaterials data
      
        <span class="hljs-keyword">if</span> matlibName
          materials = {} <span class="hljs-comment"># gets filled with materials when the promise completes</span>
<span class="hljs-function">          <span class="hljs-title">load_material_promise</span> = <span class="hljs-params">()</span> =&gt;</span>

            matlibName = @url.substring(<span class="hljs-number">0</span>,@url.lastIndexOf(<span class="hljs-string">'/'</span>)) + <span class="hljs-string">"/"</span> + matlibName</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Always remember to set the correct context when we make
an asynchronous call 
PXL.Context.switchContext _cc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            
            r2 = <span class="hljs-keyword">new</span> Request matlibName
            r2.get (matlibData) =&gt;
              @_parseMaterialFile matlibData, materials, promise_material
      

          promise_material.<span class="hljs-keyword">then</span> () =&gt;
            @_parse data, materials
            promise_data.resolve()
          
          load_material_promise()
          
        <span class="hljs-keyword">else</span>
          materials = []
          @_parse data, materials
          promise_data.resolve()

    load_data_promise()
                
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Check if this model file includes materials in a related material file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  _checkForMaterials: <span class="hljs-function"><span class="hljs-params">(text_data)</span> -&gt;</span>
    lines = text_data.split(<span class="hljs-string">"\n"</span>)
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines
      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.5</span>] == <span class="hljs-string">"mtllib"</span>
        <span class="hljs-keyword">return</span> line[<span class="hljs-number">7.</span>.]
    
      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"f "</span>
        <span class="hljs-keyword">break</span>

    <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Parse the material file data.
So far, only basic phong materials are supported and RGB colours
callback is the function called when all the items have been loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

  _parseMaterialFile : <span class="hljs-function"><span class="hljs-params">(text_data, materials, promise)</span> -&gt;</span>
    lines = text_data.split(<span class="hljs-string">"\n"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A temporary holder of promises for textures that need to be loaded
TODO - maybe a better way to do this?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _tex_promises = []
    _tex_funcs = []
    _mat_names = []

    _material_promise = <span class="hljs-keyword">new</span> Promise()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>This function is called when materials are finally loaded - close over materials and promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">_materialsLoaded</span> = <span class="hljs-params">(_materials, _mat_names, _promise)</span> -&gt;</span>

      <span class="hljs-keyword">return</span> () -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Go through all the materials and actually create them
The default shading for OBJ files is Phong Shading - this can be replaced by the user
if necessary before any draw calls (or after draw calls if you call shader automagic)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> _mat_names
          m = _materials[name]
          <span class="hljs-keyword">if</span> m.texture?
            _materials[name] = <span class="hljs-keyword">new</span> PhongMaterial m.ambient, m.texture, m.specular, m.shine
          <span class="hljs-keyword">else</span>
            _materials[name] = <span class="hljs-keyword">new</span> PhongMaterial m.ambient, m.diffuse, m.specular, m.shine
     
        _promise.resolve()
  

    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines
      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.6</span>] == <span class="hljs-string">"newmtl "</span>
        mat_name = line.split(<span class="hljs-string">" "</span>)[<span class="hljs-number">1</span>]
        materials[mat_name] = {}
        _mat_names.push mat_name

      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"Ka"</span>
        tokens = line.split <span class="hljs-string">" "</span>
        new_tokens = [parseFloat(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> tokens[<span class="hljs-number">1.</span>.]][<span class="hljs-number">0</span>]
        materials[mat_name].ambient = <span class="hljs-keyword">new</span> RGB new_tokens[<span class="hljs-number">0</span>],new_tokens[<span class="hljs-number">1</span>],new_tokens[<span class="hljs-number">2</span>]
      
      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"Kd"</span>
        tokens = line.split <span class="hljs-string">" "</span>
        new_tokens = [parseFloat(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> tokens[<span class="hljs-number">1.</span>.]][<span class="hljs-number">0</span>]
        materials[mat_name].diffuse = <span class="hljs-keyword">new</span> RGB new_tokens[<span class="hljs-number">0</span>],new_tokens[<span class="hljs-number">1</span>],new_tokens[<span class="hljs-number">2</span>]

      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"Ks"</span>
        tokens = line.split <span class="hljs-string">" "</span>
        new_tokens = [parseFloat(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> tokens[<span class="hljs-number">1.</span>.]][<span class="hljs-number">0</span>]
        materials[mat_name].specular = <span class="hljs-keyword">new</span> RGB new_tokens[<span class="hljs-number">0</span>],new_tokens[<span class="hljs-number">1</span>],new_tokens[<span class="hljs-number">2</span>]

      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"Ns"</span>
        tokens = line.split <span class="hljs-string">" "</span>
        new_tokens = [parseInt(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> tokens[<span class="hljs-number">1.</span>.]][<span class="hljs-number">0</span>]
        materials[mat_name].shine = new_tokens[<span class="hljs-number">1</span>]

      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.6</span>] == <span class="hljs-string">"map_Kd "</span>
        tex_name = line[<span class="hljs-number">7.</span>.]</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Again we assume textures are in the same place
TODO - Allow use of a texture path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        tex_url = @url.substring(<span class="hljs-number">0</span>,@url.lastIndexOf(<span class="hljs-string">'/'</span>)) + <span class="hljs-string">"/"</span> + tex_name</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Check in case we are testing or running with no webgl</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> PXL?</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Go and load some textures - create a closure over data we need</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">         
          <span class="hljs-title">_tt</span> = <span class="hljs-params">(_tex_url, _mat_name, _cc, _materials, _tex_promise)</span>  -&gt;</span>
            <span class="hljs-keyword">return</span> () -&gt;
              PXL.Context.switchContext _cc
              PXL.GL.textureFromURL _tex_url, <span class="hljs-function"><span class="hljs-params">(tex)</span> -&gt;</span>
                _materials[_mat_name].texture = tex
                _tex_promise.resolve()

          _tex_promise = <span class="hljs-keyword">new</span> Promise()
          _tex_func = _tt tex_url, mat_name, PXL.Context, materials, _tex_promise

          _tex_promises.push _tex_promise
          _tex_funcs.push _tex_func</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Now go through and see if we have any promises to resolve</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> _tex_promises.length &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Should auto resolve this promise?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _ml = _materialsLoaded materials, _mat_names, promise
      _material_promise.<span class="hljs-keyword">when</span>.apply(_material_promise, _tex_promises).<span class="hljs-keyword">then</span>( _ml )
      <span class="hljs-keyword">for</span> tf <span class="hljs-keyword">in</span> _tex_funcs
        tf()
    <span class="hljs-keyword">else</span>
      promise.resolve()
         
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Parse the data file completely, pulling in vertices
materials is an object passed in with actual materials under their name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  _parse: <span class="hljs-function"><span class="hljs-params">(text_data, materials)</span> -&gt;</span>

    positions = []
    normals = []
    texcoords = []</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Add the none material as a white, basic material</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    materials[<span class="hljs-string">"none"</span>] = <span class="hljs-keyword">new</span> BasicColourMaterial()</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>For each ‘o’ in the file, create a new node
and clear our arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    object_node = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Offsets for vertices depending on objects
basically, the faces index does NOT get reset when
a new object occurs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    offset_v = <span class="hljs-number">0</span>
    offset_t = <span class="hljs-number">0</span>
    offset_n = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Could be heavy if the file is big :S</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lines = text_data.split(<span class="hljs-string">"\n"</span>)

    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines

      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"o "</span>
      
        object_node = <span class="hljs-keyword">new</span> Node
        object_node._label = line[<span class="hljs-number">2.</span>.]
        @add object_node
    
        current_mesh = <span class="hljs-keyword">new</span> TriangleMesh <span class="hljs-literal">true</span>
        object_node.geometry = current_mesh

        offset_v = positions.length
        offset_n = normals.length
        offset_t = texcoords.length

      <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"v "</span>
        bits = line[<span class="hljs-number">2.</span>.].split <span class="hljs-string">" "</span>
        tokens = (parseFloat(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> bits)
        v = <span class="hljs-keyword">new</span> Vec3 tokens[<span class="hljs-number">0</span>], tokens[<span class="hljs-number">1</span>], tokens[<span class="hljs-number">2</span>]
        positions.push v

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.2</span>] == <span class="hljs-string">"vt "</span>
        bits = line[<span class="hljs-number">3.</span>.].split <span class="hljs-string">" "</span>
        tokens = (parseFloat(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> bits)
        v = <span class="hljs-keyword">new</span> Vec2 tokens[<span class="hljs-number">0</span>], tokens[<span class="hljs-number">1</span>]
        texcoords.push v

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.2</span>] == <span class="hljs-string">"vn "</span>
        bits = line[<span class="hljs-number">3.</span>.].split <span class="hljs-string">" "</span>
        tokens = (parseFloat(token) <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> bits)
        v = <span class="hljs-keyword">new</span> Vec3 tokens[<span class="hljs-number">0</span>], tokens[<span class="hljs-number">1</span>], tokens[<span class="hljs-number">2</span>]
        normals.push v

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.6</span>] == <span class="hljs-string">"usemtl "</span>
        mat_name = line[<span class="hljs-number">7.</span>.]
        material = materials[mat_name]</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>I <em>believe</em> it is not possible for an OBJ <em>object</em> to have
more than one material</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> object_node.material?
          object_node.material = material
        

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> line[<span class="hljs-number">0.</span><span class="hljs-number">.1</span>] == <span class="hljs-string">"f "</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Now we have faces we need to create. Good old indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        tc = line[<span class="hljs-number">2.</span>.]
        bits = tc.split <span class="hljs-string">" "</span>
        bobs = ( bit.split(<span class="hljs-string">"/"</span>) <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> bits )


        <span class="hljs-keyword">if</span> bobs.length == <span class="hljs-number">3</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>We have a lovely triangle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
          vertices = []
          <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.2</span>]
            idx_v = parseInt(bobs[i][<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>
        
            p0 = positions[idx_v]
            v = <span class="hljs-keyword">new</span> Vertex
              p : p0</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>normal lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> bobs[i][<span class="hljs-number">2</span>] != <span class="hljs-string">""</span>
              idx_n = parseInt(bobs[i][<span class="hljs-number">2</span>]) - <span class="hljs-number">1</span>

              <span class="hljs-keyword">if</span> idx_n &lt; normals.length
                v.n = normals[idx_n].copy()</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>tex coord lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> bobs[i][<span class="hljs-number">1</span>] != <span class="hljs-string">""</span>
              idx_t = parseInt(bobs[i][<span class="hljs-number">1</span>]) - <span class="hljs-number">1</span>
              <span class="hljs-keyword">if</span> idx_t &lt; texcoords.length
                v.t = texcoords[idx_t].copy()

            vertices.push v

          current_mesh.addTriangle <span class="hljs-keyword">new</span> Triangle vertices[<span class="hljs-number">0</span>], vertices[<span class="hljs-number">1</span>], vertices[<span class="hljs-number">2</span>]

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> bobs.length == <span class="hljs-number">4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>we have a nasty quad - triangulate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          vertices = []
          <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.3</span>]
            idx_v = parseInt(bobs[i][<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>
            p0 = positions[idx_v]
            
            v = <span class="hljs-keyword">new</span> Vertex
              p : p0</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>normal lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> bobs[i][<span class="hljs-number">2</span>] != <span class="hljs-string">""</span>
              idx_n = parseInt(bobs[i][<span class="hljs-number">2</span>]) - <span class="hljs-number">1</span>

              <span class="hljs-keyword">if</span> idx_n &lt; normals.length
                v.n = normals[idx_n].copy()</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>tex coord lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> bobs[i][<span class="hljs-number">1</span>] != <span class="hljs-string">""</span>
              idx_t = parseInt(bobs[i][<span class="hljs-number">1</span>]) - <span class="hljs-number">1</span>
              <span class="hljs-keyword">if</span> idx_t &lt; texcoords.length
                v.t = texcoords[idx_t].copy()

            vertices.push v

          current_mesh.addTriangle <span class="hljs-keyword">new</span> Triangle vertices[<span class="hljs-number">0</span>], vertices[<span class="hljs-number">1</span>], vertices[<span class="hljs-number">2</span>]
          current_mesh.addTriangle <span class="hljs-keyword">new</span> Triangle vertices[<span class="hljs-number">0</span>], vertices[<span class="hljs-number">2</span>], vertices[<span class="hljs-number">3</span>]
          
        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>We have something like a triangle fan</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
          vertices = []
          <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.bobs.length<span class="hljs-number">-1</span>]
            idx_v = tokens[i] - <span class="hljs-number">1</span>
            p0 = positions[idx_v]

            v = <span class="hljs-keyword">new</span> Vertex
              p : p0

            <span class="hljs-keyword">if</span> bobs[i][<span class="hljs-number">2</span>] != <span class="hljs-string">""</span>
              idx_n = parseInt(bobs[i][<span class="hljs-number">2</span>]) - <span class="hljs-number">1</span>
              <span class="hljs-keyword">if</span> idx_n &lt; normals.length
                v.n = normals[idx_n]

            <span class="hljs-keyword">if</span> bobs[i][<span class="hljs-number">1</span>] != <span class="hljs-string">""</span>
              idx_t = parseInt(bobs[i][<span class="hljs-number">1</span>]) - <span class="hljs-number">1</span>
              <span class="hljs-keyword">if</span> idx_t &lt; texcoords.length
                v.t = normals[idx_t]
                        
            vertices.push v

          <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span>.tokens.length<span class="hljs-number">-1</span>]
            <span class="hljs-keyword">if</span> i == tokens.length<span class="hljs-number">-1</span>
              current_mesh.addTriangle <span class="hljs-keyword">new</span> Triangle vertices[<span class="hljs-number">0</span>], vertices[i], vertices[<span class="hljs-number">1</span>]
            <span class="hljs-keyword">else</span>
              current_mesh.addTriangle <span class="hljs-keyword">new</span> Triangle vertices[<span class="hljs-number">0</span>], vertices[i], vertices[i+<span class="hljs-number">1</span>]

    @

<span class="hljs-built_in">module</span>.exports =
  OBJModel : OBJModel</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
