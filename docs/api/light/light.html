<!DOCTYPE html>

<html>
<head>
  <title>light.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>light.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="about">ABOUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>             .__   
_________  __|  |  
\____ \  \/  /  |  
|  |_&gt; &gt;    &lt;|  |__
|   __<span class="hljs-regexp">/__/</span>\_ \____/
|__|        \/     js

                    PXL.js
                    Benjamin Blundell - ben@pxljs.com
                    http:<span class="hljs-regexp">//</span>pxljs.com

This software <span class="hljs-keyword">is</span> released under the MIT Licence. See LICENCE.txt <span class="hljs-keyword">for</span> details

Basic forward rendering lights such as ambient, spotlight <span class="hljs-keyword">and</span> such

- TODO 
* Issue arises with timing <span class="hljs-keyword">of</span> shader definitions such as num-lights. Shader will need to 
be rebuilt essentially <span class="hljs-keyword">if</span> the lights change. To <span class="hljs-keyword">do</span> that we have a set <span class="hljs-keyword">of</span> define lines <span class="hljs-keyword">in</span> the
shader which we can modify easily. A user will need to set these <span class="hljs-keyword">if</span> they wish to mess with stuff

*updating the pos <span class="hljs-keyword">and</span> the matrix together :S tricksy</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>##</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
{Matrix4, Vec2, Vec3, Vec4} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../math/math'</span>
{RGB,RGBA} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../colour/colour'</span>
{Contract} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../gl/contract'</span>
{Fbo} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../gl/fbo'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>These are set in stone and are the actual values passed to the
shader. Ideally weâ€™d reference them, but the are basically a cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
LIGHTING_NUM_POINT_LIGHTS = <span class="hljs-number">5</span>
LIGHTING_NUM_SPOT_LIGHTS = <span class="hljs-number">5</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="ambientlight">AmbientLight</h2>
<p>Basic ambient lighting. Should be included with all basic lights</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AmbientLight</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>@constructor</strong></p>
<ul>
<li><strong>colour</strong> - a Colour.RGB - Default RGB(0,0,0)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(@colour)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @colour?
      @colour = <span class="hljs-keyword">new</span> RGB(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)

    @contract = <span class="hljs-keyword">new</span> Contract()
    @contract.roles.uAmbientLightingColour = <span class="hljs-string">"colour"</span>

  _addToNode: <span class="hljs-function"><span class="hljs-params">(node)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Overwrite and give no warning?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    node.ambientLight = @
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="pointlight">PointLight</h2>
<p>A very basic light, a point in space. Used by the node class at present
Doesnt create shadows at present (might use a different class for that)
TODO - At some point this class will need to detect forward and deferred
lighting solutions.
The static class if you will, of PointLight (the protoype) keeps a record
of all the lights in the system and it is this which is passed to the uber
shader in the end. That way, they can be passed as arrays and looped over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointLight</span></span>
 
  @_posGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_POINT_LIGHTS * <span class="hljs-number">3</span>)
  @_colourGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_POINT_LIGHTS * <span class="hljs-number">3</span>)
  @_attenuationGlobal =  <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_POINT_LIGHTS * <span class="hljs-number">4</span>)

  @contract = <span class="hljs-keyword">new</span> Contract()
  @contract.roles.uPointLightPos = <span class="hljs-string">"_posGlobal"</span>
  @contract.roles.uPointLightColour = <span class="hljs-string">"_colourGlobal"</span>
  @contract.roles.uPointLightAttenuation = <span class="hljs-string">"_attenuationGlobal"</span>
  @contract.roles.uPointLightNum = <span class="hljs-string">"_numGlobal"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Called by the node traversal section when we create our node tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  @_preDraw : <span class="hljs-function"><span class="hljs-params">(lights)</span> -&gt;</span>

    idx = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> lights?
      <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">for</span> light <span class="hljs-keyword">in</span> lights</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Light transforms are now done in the shader</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      PointLight._posGlobal[idx * <span class="hljs-number">3</span>] = light.pos.x
      PointLight._posGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>] = light.pos.y
      PointLight._posGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>] = light.pos.z

      PointLight._colourGlobal[idx * <span class="hljs-number">3</span>] = light.colour.r
      PointLight._colourGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>] = light.colour.g
      PointLight._colourGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>] = light.colour.b

      PointLight._attenuationGlobal[idx * <span class="hljs-number">4</span>] = light.attenuation.x
      PointLight._attenuationGlobal[idx * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] = light.attenuation.y
      PointLight._attenuationGlobal[idx * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] = light.attenuation.z
      PointLight._attenuationGlobal[idx * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] = light.attenuation.w

    PointLight._numGlobal = lights.length</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>@constructor</strong></p>
<ul>
<li><strong>pos</strong> - a Vec3 - Default (1,1,1)</li>
<li><strong>colour</strong> - a Colour.RGB - Default RGB.WHITE</li>
<li><strong>attenutation</strong> - an Array of Number - Length 4 - Default [100, 1.0, 0.045, 0.0075] - <strong>NOT IMPLEMENTED YET</strong>
TODO - need to add attenuation to our ubershader</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(@pos, @colour, @attenuation)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>this is a bit of a hack to get things bound to shaders but it works</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @contract = PointLight.contract
    @_posGlobal = PointLight._posGlobal
    @_colourGlobal = PointLight._colourGlobal
    @_attenuationGlobal = PointLight._attenuationGlobal
    @_numGlobal = PointLight._numGlobal

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @pos?
      @pos = <span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @colour?
      @colour = RGB.WHITE()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Attention has 4 components - range, constant, linear and quadratic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @attenuation?
      @attenuation = [ <span class="hljs-number">100</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.045</span>, <span class="hljs-number">0.0075</span> ]</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>_addToNode - called when this class is added to a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _addToNode: <span class="hljs-function"><span class="hljs-params">(node)</span> -&gt;</span>
    node.pointLights.push @
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>_removeFromNode - called when this class is removed from a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _removeFromNode: <span class="hljs-function"><span class="hljs-params">(node)</span> -&gt;</span>
    node.pointLights.splice node.pointLights.indexOf @
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="spotlight">SpotLight</h2>
<p>A SpotLight with a direction and angle (which represents how wide the beam is)
Just as in PointLight, the spotlight prototype records all spots</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpotLight</span></span>

  @_posGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS * <span class="hljs-number">3</span>)
  @_colourGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS * <span class="hljs-number">3</span>)
  @_attenuationGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS * <span class="hljs-number">4</span>)
  @_dirGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS * <span class="hljs-number">3</span>)
  @_angleGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS)
  @_expGlobal = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS)
  @_invMatrix = <span class="hljs-keyword">new</span> Float32Array(LIGHTING_NUM_SPOT_LIGHTS * <span class="hljs-number">16</span>)

  @contract = <span class="hljs-keyword">new</span> Contract()
  @contract.roles.uSpotLightPos = <span class="hljs-string">"_posGlobal"</span>
  @contract.roles.uSpotLightColour = <span class="hljs-string">"_colourGlobal"</span>
  @contract.roles.uSpotLightAttenuation = <span class="hljs-string">"_attenuationGlobal"</span>
  @contract.roles.uSpotLightDir = <span class="hljs-string">"_dirGlobal"</span>
  @contract.roles.uSpotLightAngle = <span class="hljs-string">"_angleGlobal"</span>
  @contract.roles.uSpotLightExp = <span class="hljs-string">"_expGlobal"</span>
  @contract.roles.uSpotLightNum = <span class="hljs-string">"_numGlobal"</span>
  @contract.roles.uSpotLightInvMatrix = <span class="hljs-string">"_invMatrix"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>called internally - sets up the global contract array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  @_preDraw : <span class="hljs-function"><span class="hljs-params">(lights)</span> -&gt;</span>
    idx = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> lights?
      <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">for</span> light <span class="hljs-keyword">in</span> lights
      SpotLight._posGlobal[idx * <span class="hljs-number">3</span>] = light.pos.x
      SpotLight._posGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>] = light.pos.y
      SpotLight._posGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>] = light.pos.z

      SpotLight._colourGlobal[idx * <span class="hljs-number">3</span>] = light.colour.r
      SpotLight._colourGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>] = light.colour.g
      SpotLight._colourGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>] = light.colour.b

      SpotLight._attenuationGlobal[idx * <span class="hljs-number">4</span>] = light.attenuation.x
      SpotLight._attenuationGlobal[idx * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] = light.attenuation.y
      SpotLight._attenuationGlobal[idx * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] = light.attenuation.z
      SpotLight._attenuationGlobal[idx * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] = light.attenuation.w
      
      SpotLight._dirGlobal[idx * <span class="hljs-number">3</span>] = light.dir.x
      SpotLight._dirGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>] = light.dir.y
      SpotLight._dirGlobal[idx * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>] = light.dir.z

      SpotLight._angleGlobal[idx] = light.angle
      SpotLight._expGlobal[idx] = light.exponent
      
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.15</span>]
        SpotLight._invMatrix[idx*<span class="hljs-number">16</span>+i] = light.invMatrix.a[i]

      idx += <span class="hljs-number">1</span>

    SpotLight.numGlobal = lights.length</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO - Add a mask here that basically says which lights are on or off
We need this because we may call draw on a subnode of a node that has a light
and that light should not affect the scene. this mask would be passed to the shader</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong>@constructor</strong> 
-<strong>pos</strong> - a Vec3
-<strong>colour</strong> - an RGB
-<strong>dir</strong> - a Vec3
-<strong>angle</strong> - a Number - radians
-<strong>exponent</strong> - a Number
-<strong>shadowmap</strong> - a Boolean
-<strong>attentuation</strong> - a List of Number - length 4 - optional - default [100, 1.0, 0.045, 0.0075]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(@pos, @colour, @dir, @angle, @shadowmap, @exponent, @attenuation)</span> -&gt;</span>

    @contract = SpotLight.contract

    @_posGlobal = SpotLight._posGlobal
    @_colourGlobal = SpotLight._colourGlobal
    @_attenuationGlobal = SpotLight._attenuationGlobal
    @_dirGlobal = SpotLight._dirGlobal
    @_angleGlobal = SpotLight._angleGlobal
    @_expGlobal = SpotLight._expGlobal
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @pos?
      @pos = <span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @colour?
      @colour = RGB.WHITE()

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @shadowmap?
      @shadowmap = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">if</span> @shadowmap
      @shadowmap_fbo = <span class="hljs-keyword">new</span> Fbo(<span class="hljs-number">640</span>,<span class="hljs-number">640</span>)
      @invMatrix = <span class="hljs-keyword">new</span> Matrix4()</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Attenuation has 4 components - range, constant, linear and quadratic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @attenuation?
      @attenuation = [ <span class="hljs-number">10</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.045</span>, <span class="hljs-number">0.0075</span> ]
  
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @dir?
      @dir = <span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>)

    @dir.normalize()

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @angle?
      @angle = <span class="hljs-number">45.0</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @exponent?
      @exponent = <span class="hljs-number">100.0</span>

    @idx = <span class="hljs-number">-1</span> <span class="hljs-comment"># Used to say where in the global array this light is</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>_addToNode - called when this class is added to a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _addToNode: <span class="hljs-function"><span class="hljs-params">(node)</span> -&gt;</span>
    node.spotLights.push @
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>_removeFromNode - called when this class is removed from a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _removeFromNode: <span class="hljs-function"><span class="hljs-params">(node)</span> -&gt;</span>
    node.spotLights.splice node.spotLights.indexOf @
    @



<span class="hljs-built_in">module</span>.exports =
  PointLight : PointLight
  AmbientLight : AmbientLight
  SpotLight : SpotLight</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

