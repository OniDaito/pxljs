<!DOCTYPE html>

<html>
<head>
  <title>animation.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>animation.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="about">ABOUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>             .__   
_________  __|  |  
\____ \  \/  /  |  
|  |_&gt; &gt;    &lt;|  |__
|   __<span class="hljs-regexp">/__/</span>\_ \____/
|__|        \/     js

                    PXL.js
                    Benjamin Blundell - ben@pxljs.com
                    http:<span class="hljs-regexp">//</span>pxljs.com

This software <span class="hljs-keyword">is</span> released under the MIT Licence. See LICENCE.txt <span class="hljs-keyword">for</span> details</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>##</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
{Vec2, Vec3, Vec4, Matrix4} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../math/math'</span>
{RGB, RGBA} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../colour/colour'</span>
{PXLWarning} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../util/log'</span>
{Curve2} = <span class="hljs-built_in">require</span> <span class="hljs-string">'../math/curve'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="interpolation">Interpolation</h2>
<p>A basic wrapper around a math / colour value that performs linear interpolation
TODO - Quaternionâ€™s need to be here and probably just SLERPED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Interpolation</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><strong>@constructor</strong> - creates a new interpolation object</p>
<ul>
<li><strong>obj0</strong> - an object of type Vec3, Vec3, RGB, RGBA, Quaternion or Number</li>
<li><strong>obj1</strong> - an object of type Vec3, Vec3, RGB, RGBA, Quaternion or Number </li>
<li><strong>curve</strong> - a Curve</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(@obj0, @obj1, @curve)</span> -&gt;</span>
  
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @curve?
      @curve = <span class="hljs-keyword">new</span> Curve2()

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> @obj0 == <span class="hljs-string">'object'</span> 
      <span class="hljs-keyword">if</span> @obj0.__proto__  != @obj1.__proto__
        PXLWarning <span class="hljs-string">"Interpolating two different objects"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>could replace this with simply interpolating all dictionary values that are numbers?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> @obj0 <span class="hljs-keyword">instanceof</span> Vec2
      @_set = @_setVec2

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @obj0 <span class="hljs-keyword">instanceof</span> Vec3
      @_set = @_setVec3

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @obj0 <span class="hljs-keyword">instanceof</span> Vec4
      @_set = @_setVec4

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @obj0 <span class="hljs-keyword">instanceof</span> RGB
      @_set = @_setRGB

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @obj0 <span class="hljs-keyword">instanceof</span> RGBA
      @_set = @_setRGBA

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> @obj0 <span class="hljs-keyword">instanceof</span> Quaternion
      @_set = @_setQuat

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> @obj0 == <span class="hljs-string">'number'</span>
      @_set = @_setScalar

    @_value = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>set</strong> - set the value of this object</p>
<ul>
<li><strong>val</strong> - a Number - 0 to 1 range</li>
<li>returns a new Object of the same type as obj0 passed into the constructor</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set : <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> val &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> val &gt; <span class="hljs-number">1.0</span>
      PXLWarning(<span class="hljs-string">"Interpolation set val must be between 0 and 1. It was set to "</span> + val)
    @_value = val

    @_set()

  _setVec2 : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">new</span> Vec2(@obj0.x + ((@obj.x - @obj0.x) * @_value), @obj0.y + ((@obj1.y - @obj0.y) * @_value))

  _setVec3 : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">new</span> Vec3(@obj0.x + ((@obj1.x - @obj0.x) * @_value), 
        @obj0.y + ((@obj1.y - @obj0.y) * @_value),
        @obj0.z + ((@obj1.z - @obj0.z) * @_value)
    )

  _setVec4 : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">new</span> Vec4(@obj0.x + ((@obj1.x - @obj0.x) * @_value), 
        @obj0.y + ((@obj1.y - @obj0.y) * @_value),
        @obj0.z + ((@obj1.z - @obj0.z) * @_value),
        @obj0.w + ((@obj1.w - @obj0.w) * @_value)
    )

   _setRGB : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">new</span> RGB(@obj0.r + ((@obj1.r - @obj0.r) * @_value), 
        @obj0.g + ((@obj1.g - @obj0.g) * @_value),
        @obj0.b + ((@obj1.b - @obj0.b) * @_value)
    )

  _setRGBA : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">new</span> RGBA(@obj0.r + ((@obj1.r - @obj0.r) * @_value), 
        @obj0.g + ((@obj1.g - @obj0.g) * @_value),
        @obj0.b + ((@obj1.b - @obj0.b) * @_value),
        @obj0.a + ((@obj1.a - @obj0.a) * @_value)
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>for a quaternion, we default to slerping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _setQuat : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    @obj0.slerp @obj1, @_value 

  _setScalar : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    @obj0 + ((@obj1 - @obj0) * @_value)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h1 id="animator">Animator</h1>
<p>A class that deals with animation. Essentially runs a series of frames at a particular framerate, with start / stop options
TODO - Lots of testing of copyFrom - we might need to improve on that as its only numbers that violate that rule?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Animator</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>@constructor</strong></p>
<ul>
<li><strong>num_frames</strong> - a Number</li>
<li><strong>framerate</strong> - a Number</li>
<li><strong>label</strong> - a String</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  constructor : <span class="hljs-function"><span class="hljs-params">(@num_frames, @framerate, @label)</span> -&gt;</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @framerate?
      @framerate = <span class="hljs-number">24</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @label?
      @label = <span class="hljs-string">"unlabled_animaton"</span>

    @_current_frame = <span class="hljs-number">0</span>
    @_dt = <span class="hljs-number">0</span>
    @_loop = <span class="hljs-literal">true</span>
    @_frover = <span class="hljs-number">1.0</span> / @framerate
    @_tweens = []</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>addTween</strong> - Add a tween to this keyframe</p>
<ul>
<li><strong>tween</strong> - a Tween</li>
<li>returns this</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addTween : <span class="hljs-function"><span class="hljs-params">(tween)</span> -&gt;</span>
    @_tweens.push tween
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>reset</strong> - set the animation back to the start position</p>
<ul>
<li>returns this </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    @_dt = <span class="hljs-number">0</span>
    @_current_frame = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> tween <span class="hljs-keyword">in</span> @_tweens
      tween.reset()
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>step</strong> - Call step inside your draw function or similar, passing in dt - time time difference in seconds</p>
<ul>
<li><strong>dt</strong> - a Number</li>
<li>returns this</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  step : <span class="hljs-function"><span class="hljs-params">(dt)</span> -&gt;</span>

    @_dt += dt
 
    <span class="hljs-keyword">if</span> @_dt &gt;= @_frover</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>dt can be over the next frame by more than half a frame amount so we should think about this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ff = Math.floor @_dt / @_frover
      @_current_frame += ff
      <span class="hljs-keyword">if</span> @_current_frame &gt;= @num_frames
        <span class="hljs-keyword">if</span> @_loop
          reset()
        
      @_process()
      @_dt = @_dt - (ff * @_frover)
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Internal function that processes the values proper
We step through each tween and check where we are at with it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _process : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">for</span> tween <span class="hljs-keyword">in</span> @_tweens
      <span class="hljs-keyword">if</span> tween.f0.framenum &lt;= @_current_frame <span class="hljs-keyword">and</span> tween.f1.framenum &gt;= @_current_frame
        p = Math.abs(@_current_frame - tween.f0.framenum) /  Math.abs(tween.f0.framenum - tween.f1.framenum )
        tween.set p</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="keyframe">KeyFrame</h2>
<p>A reference to an object and the value that object should take at that point.
Add keyframes to animators with the appropriate values</p>
<p>TODO - should we pass in seconds or frames here?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeyFrame</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong>@constructor</strong></p>
<ul>
<li><strong>obj</strong> - an Object</li>
<li><strong>value</strong> - a Value obj should take</li>
<li><strong>framenum</strong> - the framenumber at which point this object should take this value</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(@obj, @value, @framenum)</span> -&gt;</span>
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="tween">Tween</h2>
<p>A simple class that basically takes two keyframes and uses an interpolator to move between said values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tween</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong>@constructor</strong> </p>
<ul>
<li><strong>f0</strong> - a KeyFrame</li>
<li><strong>f1</strong> - a KeyFrame</li>
<li><strong>interp</strong> - an Interpolation</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(@f0, @f1, @interp)</span> -&gt;</span>
    
    <span class="hljs-keyword">if</span> @f0.obj != @f1.obj
      PXLWarning <span class="hljs-string">"Tween Keyframes do not point to the same object"</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @interp?
      @interp = <span class="hljs-keyword">new</span> Interpolation @f0.value, @f1.value

    <span class="hljs-keyword">if</span> @f0.obj.copy?
      @_original = @f0.obj.clone()
      @reset = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
        @f0.copy @_original
    <span class="hljs-keyword">else</span>
      @_original = @f0
      @reset = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
        @f0 = @_original
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong>set</strong></p>
<ul>
<li><strong>u</strong> - a Number - 0 to 1 range</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-params">(u)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> @f0.obj.copy?
      @f0.obj.copy @interp.set(u)
    <span class="hljs-keyword">else</span>
      @f0.obj = @interp.set(u)

<span class="hljs-built_in">module</span>.exports =
  Interpolation : Interpolation
  KeyFrame : KeyFrame
  Animator : Animator
  Tween : Tween</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

